from aiogram import types

from services.profile import profile
from services.auth import auth

student_menu = types.InlineKeyboardMarkup(
    inline_keyboard=[
        [
            types.InlineKeyboardButton(text="üë®‚Äçüè´ –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏", callback_data="student_view_teachers"),
            types.InlineKeyboardButton(text="üìÑ –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é", callback_data="student_requests")
        ],
        [
            types.InlineKeyboardButton(text="üìù –°–æ–∑–¥–∞—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é", callback_data="student_create_request")
        ],
        [
            types.InlineKeyboardButton(text="üìÖ –ú–æ–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏", callback_data="student_my_consultations"),
        ],
        [
            types.InlineKeyboardButton(text="üë§ –ü—Ä–æ—Ñ–∏–ª—å", callback_data="menu_profile"),
            types.InlineKeyboardButton(text="üö™ –í—ã–π—Ç–∏", callback_data="menu_logout")
        ],
        [
            types.InlineKeyboardButton(text="‚ùì –°–ø—Ä–∞–≤–∫–∞", callback_data="menu_help")
        ]
    ]
)

teacher_menu = types.InlineKeyboardMarkup(
    inline_keyboard=[
        [
            types.InlineKeyboardButton(text="‚ûï –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é", callback_data="teacher_create_consultation"),
        ],
        [
            types.InlineKeyboardButton(text="üîí –ó–∞–∫—Ä—ã—Ç—å –∑–∞–ø–∏—Å—å", callback_data="teacher_close_consultation"),
            types.InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é", callback_data="teacher_cancel_consultation")
        ],
        [
            types.InlineKeyboardButton(text="üìù –ó–∞–ø—Ä–æ—Å—ã —Å—Ç—É–¥–µ–Ω—Ç–æ–≤", callback_data="teacher_requests")
        ],
        [
            types.InlineKeyboardButton(text="üìÖ –ú–æ–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏", callback_data="teacher_my_consultations")
        ],
        [
            types.InlineKeyboardButton(text="üë§ –ü—Ä–æ—Ñ–∏–ª—å", callback_data="menu_profile"),
            types.InlineKeyboardButton(text="üö™ –í—ã–π—Ç–∏", callback_data="menu_logout")
        ],
        [
            types.InlineKeyboardButton(text="‚ùì –°–ø—Ä–∞–≤–∫–∞", callback_data="menu_help")
        ]
    ]
)

teacher_unconfirmed_menu = types.InlineKeyboardMarkup(
    inline_keyboard=[
        [
            types.InlineKeyboardButton(text="üë§ –ü—Ä–æ—Ñ–∏–ª—å", callback_data="menu_profile"),
            types.InlineKeyboardButton(text="üö™ –í—ã–π—Ç–∏", callback_data="menu_logout")
        ],
        [
            types.InlineKeyboardButton(text="‚ùì –°–ø—Ä–∞–≤–∫–∞", callback_data="menu_help")
        ]
    ]
)

guest_menu = types.InlineKeyboardMarkup(
    inline_keyboard=[
        [
            types.InlineKeyboardButton(text="üîë –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è / –í—Ö–æ–¥", callback_data="start")
        ],
        [
            types.InlineKeyboardButton(text="‚ùì –°–ø—Ä–∞–≤–∫–∞", callback_data="menu_help")
        ]
    ]
)


def show_main_menu_target_message(obj: types.Message | types.CallbackQuery) -> types.Message:
    return obj.message if isinstance(obj, types.CallbackQuery) else obj


async def show_main_menu(obj: types.Message | types.CallbackQuery, role: str | None, edit_message: types.Message | None = None):
    if isinstance(obj, types.CallbackQuery):
        telegram_id = obj.from_user.id
        base_message = obj.message
    else:
        telegram_id = obj.from_user.id
        base_message = obj

    first_name, last_name = await auth.get_user_name(telegram_id)

    if role == "student":
        greeting = f"üéì –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {first_name} {last_name}."
        keyboard = student_menu
    elif role == "teacher":
        status = await profile.get_teacher_status(telegram_id)
        greeting = f"üë®‚Äçüè´ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {first_name} {last_name}."

        if status == "active":
            keyboard = teacher_menu
        else:
            greeting += "\n\n‚è≥ –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.\n–ü–æ–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏." if status == "pending" else "\n\n‚ùå –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –±—ã–ª–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.\n–ü–æ–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏."
            keyboard = teacher_unconfirmed_menu
    else:
        greeting = "üëã –ü—Ä–∏–≤–µ—Ç!\n\n–ß—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É üëá"
        keyboard = guest_menu

    target_message = edit_message or base_message
    if edit_message:
        await target_message.edit_text(greeting, reply_markup=keyboard)
    else:
        await target_message.answer(greeting, reply_markup=keyboard)
